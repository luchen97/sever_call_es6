/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/Room.ts":
/*!*********************!*\
  !*** ./src/Room.ts ***!
  \*********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"Room\": () => (/* binding */ Room)\n/* harmony export */ });\n/* harmony import */ var _config__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./config */ \"./src/config.ts\");\nvar __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (undefined && undefined.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __spreadArray = (undefined && undefined.__spreadArray) || function (to, from) {\n    for (var i = 0, il = from.length, j = to.length; i < il; i++, j++)\n        to[j] = from[i];\n    return to;\n};\n\nvar Room = /** @class */ (function () {\n    function Room(name, password, worker, io) {\n        var _this = this;\n        this.initRouter = function () { return __awaiter(_this, void 0, void 0, function () {\n            var mediaCodecs, _a;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        mediaCodecs = _config__WEBPACK_IMPORTED_MODULE_0__.config.mediasoup.router.mediaCodecs;\n                        _a = this;\n                        return [4 /*yield*/, this.worker.createRouter({ mediaCodecs: mediaCodecs })];\n                    case 1:\n                        _a.router = _b.sent();\n                        return [2 /*return*/];\n                }\n            });\n        }); };\n        this.addUser = function (user) {\n            _this.userOnRoom.push({ socketId: user.socketId, username: user.username });\n            _this.listUser.set(user.socketId, user);\n        };\n        this.removeUser = function (socketId) {\n            _this.listUser.delete(socketId);\n        };\n        this.getUserOnRoom = function () {\n            return _this.userOnRoom;\n        };\n        this.getListUser = function () {\n            return { roomname: _this.name, users: JSON.stringify(__spreadArray([], _this.listUser)) };\n        };\n        this.createTransport = function (socketId) { return __awaiter(_this, void 0, void 0, function () {\n            var _a, maxIncomingBitrate, initialAvailableOutgoingBitrate, listenIps, transport, error_1;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        _a = _config__WEBPACK_IMPORTED_MODULE_0__.config.mediasoup.webRtcTransport, maxIncomingBitrate = _a.maxIncomingBitrate, initialAvailableOutgoingBitrate = _a.initialAvailableOutgoingBitrate, listenIps = _a.listenIps;\n                        return [4 /*yield*/, this.router.createWebRtcTransport({\n                                listenIps: listenIps,\n                                enableUdp: true,\n                                enableTcp: true,\n                                preferUdp: true,\n                                initialAvailableOutgoingBitrate: initialAvailableOutgoingBitrate,\n                            })];\n                    case 1:\n                        transport = _b.sent();\n                        if (!maxIncomingBitrate) return [3 /*break*/, 5];\n                        _b.label = 2;\n                    case 2:\n                        _b.trys.push([2, 4, , 5]);\n                        return [4 /*yield*/, transport.setMaxIncomingBitrate(maxIncomingBitrate)];\n                    case 3:\n                        _b.sent();\n                        return [3 /*break*/, 5];\n                    case 4:\n                        error_1 = _b.sent();\n                        return [3 /*break*/, 5];\n                    case 5:\n                        // transport.on(\n                        //   TRANSPORT_EVENTS.STATE_CHANGE,\n                        //   (dtlsState: ETransportState) => {\n                        //     if (dtlsState === ETransportState.CLOSED) {\n                        //       //   console.log(\n                        //       //     \"---transport close--- \" +\n                        //       //       this.peers.get(socket_id).name +\n                        //       //       \" closed\"\n                        //       //   );\n                        //       transport.close();\n                        //     }\n                        //   }\n                        // );\n                        // transport.on(TRANSPORT_EVENTS.CLOSE, () => {});\n                        this.listUser.get(socketId).addTransport(transport);\n                        return [2 /*return*/, {\n                                params: {\n                                    id: transport.id,\n                                    iceParameters: transport.iceParameters,\n                                    iceCandidates: transport.iceCandidates,\n                                    dtlsParameters: transport.dtlsParameters,\n                                },\n                            }];\n                }\n            });\n        }); };\n        this.connectPeerTransport = function (socketId, transportId, dtlsParameters) { return __awaiter(_this, void 0, void 0, function () {\n            var user;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!this.listUser.has(socketId))\n                            return [2 /*return*/];\n                        user = this.listUser.get(socketId);\n                        return [4 /*yield*/, user.connectTransport(transportId, dtlsParameters)];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        }); };\n        this.router = null;\n        this.userKey = null;\n        this.listUser = new Map();\n        this.userOnRoom = [];\n        this.password = password;\n        this.listMessage = [];\n        this.io = io;\n        this.name = name;\n        this.worker = worker;\n        this.initRouter();\n    }\n    Room.prototype.getProducerListForPeer = function (socketId) {\n        var producerList = [];\n        this.listUser.forEach(function (user) {\n            user.producers.forEach(function (producer) {\n                producerList.push({\n                    producer_id: producer.id,\n                    peerName: user.username,\n                    peerId: user.socketId,\n                    isKey: user.isKey\n                });\n            });\n        });\n        return producerList;\n    };\n    Room.prototype.broadCast = function (socketId, name, data) {\n        for (var _i = 0, _a = Array.from(this.listUser.keys()).filter(function (id) { return id !== socketId; }); _i < _a.length; _i++) {\n            var otherID = _a[_i];\n            this.send(otherID, name, data);\n        }\n    };\n    Room.prototype.send = function (socketId, name, data) {\n        this.io.to(socketId).emit(name, data);\n    };\n    Room.prototype.sendAll = function (name, data) {\n        for (var _i = 0, _a = Array.from(this.listUser.keys()); _i < _a.length; _i++) {\n            var otherID = _a[_i];\n            this.send(otherID, name, data);\n        }\n    };\n    Room.prototype.addMessage = function (socketId, message) {\n        var user = this.listUser.get(socketId);\n        var data = { id: socketId, message: message, name: user.username };\n        this.listMessage.push(data);\n        this.sendAll(\"INCOMMING_MESSAGE\" /* INCOMMING_MESSAGE */, this.listMessage);\n    };\n    return Room;\n}());\n\n\n\n//# sourceURL=webpack://call_server_es6/./src/Room.ts?");

/***/ }),

/***/ "./src/User.ts":
/*!*********************!*\
  !*** ./src/User.ts ***!
  \*********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"User\": () => (/* binding */ User)\n/* harmony export */ });\n/* harmony import */ var _config__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./config */ \"./src/config.ts\");\nvar __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (undefined && undefined.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\n\nvar User = /** @class */ (function () {\n    function User(io, socketId, username, isKey) {\n        var _this = this;\n        this.createTransport = function (router) { return __awaiter(_this, void 0, void 0, function () {\n            var _a, maxIncomingBitrate, initialAvailableOutgoingBitrate, listenIps, transport, error_1;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        _a = _config__WEBPACK_IMPORTED_MODULE_0__.config.mediasoup.webRtcTransport, maxIncomingBitrate = _a.maxIncomingBitrate, initialAvailableOutgoingBitrate = _a.initialAvailableOutgoingBitrate, listenIps = _a.listenIps;\n                        return [4 /*yield*/, router.createWebRtcTransport({\n                                listenIps: listenIps,\n                                enableUdp: true,\n                                enableTcp: true,\n                                preferUdp: true,\n                                initialAvailableOutgoingBitrate: initialAvailableOutgoingBitrate,\n                            })];\n                    case 1:\n                        transport = _b.sent();\n                        if (!maxIncomingBitrate) return [3 /*break*/, 5];\n                        _b.label = 2;\n                    case 2:\n                        _b.trys.push([2, 4, , 5]);\n                        return [4 /*yield*/, transport.setMaxIncomingBitrate(maxIncomingBitrate)];\n                    case 3:\n                        _b.sent();\n                        return [3 /*break*/, 5];\n                    case 4:\n                        error_1 = _b.sent();\n                        return [3 /*break*/, 5];\n                    case 5:\n                        this.transports.set(transport.id, transport);\n                        return [2 /*return*/, {\n                                params: {\n                                    id: transport.id,\n                                    iceParameters: transport.iceParameters,\n                                    iceCandidates: transport.iceCandidates,\n                                    dtlsParameters: transport.dtlsParameters,\n                                },\n                            }];\n                }\n            });\n        }); };\n        this.connectTransport = function (transportId, dtlsParameters) { return __awaiter(_this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!this.transports.has(transportId))\n                            return [2 /*return*/];\n                        return [4 /*yield*/, this.transports.get(transportId).connect({\n                                dtlsParameters: dtlsParameters,\n                            })];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        }); };\n        this.createProducer = function (producerTransportId, rtpParameters, kind) { return __awaiter(_this, void 0, void 0, function () {\n            var producer;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.transports.get(producerTransportId).produce({\n                            kind: kind,\n                            rtpParameters: rtpParameters,\n                        })];\n                    case 1:\n                        producer = _a.sent();\n                        this.producers.set(producer.id, producer);\n                        producer.on(\"transportclose\", function () {\n                            console.log(\"transportclose\");\n                            producer.close();\n                            _this.producers.delete(producer.id);\n                        });\n                        return [2 /*return*/, producer];\n                }\n            });\n        }); };\n        this.createConsumer = function (consumerTransportId, producerId, rtpCapabilities) { return __awaiter(_this, void 0, void 0, function () {\n            var consumerTransport, consumer, error_2;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        consumerTransport = this.transports.get(consumerTransportId);\n                        consumer = null;\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 3, , 4]);\n                        return [4 /*yield*/, consumerTransport.consume({\n                                producerId: producerId,\n                                rtpCapabilities: rtpCapabilities,\n                                paused: false, //producer.kind === 'video',\n                            })];\n                    case 2:\n                        consumer = _a.sent();\n                        return [3 /*break*/, 4];\n                    case 3:\n                        error_2 = _a.sent();\n                        console.error(\"consume failed\", error_2);\n                        return [2 /*return*/];\n                    case 4:\n                        if (!(consumer.type === \"simulcast\")) return [3 /*break*/, 6];\n                        return [4 /*yield*/, consumer.setPreferredLayers({\n                                spatialLayer: 2,\n                                temporalLayer: 2,\n                            })];\n                    case 5:\n                        _a.sent();\n                        _a.label = 6;\n                    case 6:\n                        this.consumers.set(consumer.id, consumer);\n                        consumer.on(\"transportclose\", function () {\n                            _this.consumers.delete(consumer.id);\n                        });\n                        consumer.on(\"producerclose\", function () {\n                            _this.consumers.delete(consumer.id);\n                            // console.log(`---consumer closed--- due to producerclose event  name:${this.peers.get(socket_id).name} consumer_id: ${consumer.id}`)\n                            // this.peers.get(socket_id).removeConsumer(consumer.id)\n                            // // tell client consumer is dead\n                            _this.io.to(_this.socketId).emit(\"CLOSE_CONSUME\" /* CLOSE_CONSUME */, {\n                                consumerId: consumer.id,\n                            });\n                        });\n                        return [2 /*return*/, {\n                                consumer: consumer,\n                                params: {\n                                    producerId: producerId,\n                                    id: consumer.id,\n                                    kind: consumer.kind,\n                                    rtpParameters: consumer.rtpParameters,\n                                    type: consumer.type,\n                                    producerPaused: consumer.producerPaused,\n                                },\n                            }];\n                }\n            });\n        }); };\n        this.closeProducer = function (producerId) {\n            console.log(producerId, _this.producers);\n            try {\n                _this.producers.get(producerId).close();\n            }\n            catch (e) {\n                console.warn(e);\n            }\n            _this.producers.delete(producerId);\n        };\n        this.io = io;\n        this.socketId = socketId;\n        this.username = username;\n        this.isKey = isKey;\n        this.transports = new Map();\n        this.consumers = new Map();\n        this.producers = new Map();\n    }\n    return User;\n}());\n\n\n\n//# sourceURL=webpack://call_server_es6/./src/User.ts?");

/***/ }),

/***/ "./src/config.ts":
/*!***********************!*\
  !*** ./src/config.ts ***!
  \***********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"config\": () => (/* binding */ config)\n/* harmony export */ });\n/* harmony import */ var os__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! os */ \"os\");\n/* harmony import */ var os__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(os__WEBPACK_IMPORTED_MODULE_0__);\n\nvar config = {\n    listenIp: \"103.237.144.205\",\n    // listenIp: \"192.168.1.26\",\n    listenPort: 3017,\n    sslCrt: \"./ssl/cert.pem\",\n    sslKey: \"./ssl/key.pem\",\n    mediasoup: {\n        // Worker settings\n        numWorkers: 10 || 0,\n        worker: {\n            rtcMinPort: 10000,\n            rtcMaxPort: 10100,\n            logLevel: \"debug\",\n            logTags: [\n                \"info\",\n                \"ice\",\n                \"dtls\",\n                \"rtp\",\n                \"srtp\",\n                \"rtcp\",\n                \"rtx\",\n                \"bwe\",\n                \"score\",\n                \"simulcast\",\n                \"svc\",\n            ],\n        },\n        // Router settings\n        router: {\n            mediaCodecs: [\n                {\n                    kind: \"audio\",\n                    mimeType: \"audio/opus\",\n                    clockRate: 48000,\n                    channels: 2,\n                },\n                {\n                    kind: \"video\",\n                    mimeType: \"video/VP8\",\n                    clockRate: 90000,\n                    parameters: {\n                        \"x-google-start-bitrate\": 1000,\n                    },\n                },\n                {\n                    kind: \"video\",\n                    mimeType: \"video/VP9\",\n                    clockRate: 90000,\n                    parameters: {\n                        \"profile-id\": 2,\n                        \"x-google-start-bitrate\": 1000,\n                    },\n                },\n                {\n                    kind: \"video\",\n                    mimeType: \"video/h264\",\n                    clockRate: 90000,\n                    parameters: {\n                        \"packetization-mode\": 1,\n                        \"profile-level-id\": \"4d0032\",\n                        \"level-asymmetry-allowed\": 1,\n                        \"x-google-start-bitrate\": 1000,\n                    },\n                },\n                {\n                    kind: \"video\",\n                    mimeType: \"video/h264\",\n                    clockRate: 90000,\n                    parameters: {\n                        \"packetization-mode\": 1,\n                        \"profile-level-id\": \"42e01f\",\n                        \"level-asymmetry-allowed\": 1,\n                        \"x-google-start-bitrate\": 1000,\n                    },\n                },\n            ],\n        },\n        // WebRtcTransport settings\n        webRtcTransport: {\n            listenIps: [\n                {\n                    ip: \"103.237.144.205\",\n                    announcedIp: \"103.237.144.205\", // replace by public IP address\n                    // ip: \"192.168.1.26\",\n                    // announcedIp: \"192.168.1.26\", // replace by public IP address\n                },\n            ],\n            initialAvailableOutgoingBitrate: 1000000,\n            minimumAvailableOutgoingBitrate: 600000,\n            maxIncomingBitrate: 1500000,\n        },\n    },\n};\n\n\n\n//# sourceURL=webpack://call_server_es6/./src/config.ts?");

/***/ }),

/***/ "./src/index.ts":
/*!**********************!*\
  !*** ./src/index.ts ***!
  \**********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _config__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./config */ \"./src/config.ts\");\n/* harmony import */ var _servers_nodeServer__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./servers/nodeServer */ \"./src/servers/nodeServer.ts\");\n/* harmony import */ var _servers_socket__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./servers/socket */ \"./src/servers/socket.ts\");\n/* harmony import */ var _workerManager__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./workerManager */ \"./src/workerManager.ts\");\nvar __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (undefined && undefined.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\n\n\n\n\nvar httpsServer = (0,_servers_nodeServer__WEBPACK_IMPORTED_MODULE_1__.nodeServer)().httpsServer;\nvar socketServer = (0,_servers_socket__WEBPACK_IMPORTED_MODULE_2__.initSocketServer)(httpsServer);\nhttpsServer.listen(_config__WEBPACK_IMPORTED_MODULE_0__.config.listenPort, function () { return __awaiter(void 0, void 0, void 0, function () {\n    return __generator(this, function (_a) {\n        console.log(\"listening http \" + _config__WEBPACK_IMPORTED_MODULE_0__.config.listenPort);\n        return [2 /*return*/];\n    });\n}); });\nvar main = function () { return __awaiter(void 0, void 0, void 0, function () {\n    return __generator(this, function (_a) {\n        switch (_a.label) {\n            case 0: return [4 /*yield*/, (0,_workerManager__WEBPACK_IMPORTED_MODULE_3__.initWorker)()];\n            case 1:\n                _a.sent();\n                return [2 /*return*/];\n        }\n    });\n}); };\nmain();\n\n\n//# sourceURL=webpack://call_server_es6/./src/index.ts?");

/***/ }),

/***/ "./src/roomManager.ts":
/*!****************************!*\
  !*** ./src/roomManager.ts ***!
  \****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"roomList\": () => (/* binding */ roomList)\n/* harmony export */ });\nvar roomList = new Map();\n\n\n\n//# sourceURL=webpack://call_server_es6/./src/roomManager.ts?");

/***/ }),

/***/ "./src/servers/nodeServer.ts":
/*!***********************************!*\
  !*** ./src/servers/nodeServer.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"nodeServer\": () => (/* binding */ nodeServer)\n/* harmony export */ });\n/* harmony import */ var httpolyglot__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! httpolyglot */ \"httpolyglot\");\n/* harmony import */ var httpolyglot__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(httpolyglot__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! fs */ \"fs\");\n/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(fs__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var express__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! express */ \"express\");\n/* harmony import */ var express__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(express__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var _config__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../config */ \"./src/config.ts\");\n/* harmony import */ var _roomManager__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../roomManager */ \"./src/roomManager.ts\");\n\n\n\n\n\nvar nodeServer = function () {\n    var option = {\n        key: fs__WEBPACK_IMPORTED_MODULE_1__.readFileSync(_config__WEBPACK_IMPORTED_MODULE_3__.config.sslKey),\n        cert: fs__WEBPACK_IMPORTED_MODULE_1__.readFileSync(_config__WEBPACK_IMPORTED_MODULE_3__.config.sslCrt),\n    };\n    var app = express__WEBPACK_IMPORTED_MODULE_2___default()();\n    app.use(express__WEBPACK_IMPORTED_MODULE_2___default().static(\"public\"));\n    app.all(\"*\", function (req, res, next) {\n        res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n        res.setHeader(\"Access-Control-Allow-Methods\", \"GET, POST, OPTIONS, PUT, PATCH, DELETE\");\n        res.setHeader(\"Access-Control-Allow-Headers\", \"X-Requested-With,content-type\");\n        res.setHeader(\"Access-Control-Allow-Credentials\", true);\n        next();\n    });\n    app.get(\"/checkRoom\", function (req, res) {\n        var roomname = req.query.roomname;\n        var roomhas = _roomManager__WEBPACK_IMPORTED_MODULE_4__.roomList.get(roomname);\n        console.log(roomname, roomhas, _roomManager__WEBPACK_IMPORTED_MODULE_4__.roomList);\n        if (roomhas) {\n            res.send(false);\n        }\n        else {\n            res.send(true);\n        }\n    });\n    var httpsServer = httpolyglot__WEBPACK_IMPORTED_MODULE_0__.createServer(option, app);\n    return { httpsServer: httpsServer };\n};\n\n\n\n//# sourceURL=webpack://call_server_es6/./src/servers/nodeServer.ts?");

/***/ }),

/***/ "./src/servers/socket.ts":
/*!*******************************!*\
  !*** ./src/servers/socket.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"initSocketServer\": () => (/* binding */ initSocketServer)\n/* harmony export */ });\n/* harmony import */ var socket_io__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! socket.io */ \"socket.io\");\n/* harmony import */ var socket_io__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(socket_io__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _Room__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../Room */ \"./src/Room.ts\");\n/* harmony import */ var _roomManager__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../roomManager */ \"./src/roomManager.ts\");\n/* harmony import */ var _User__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../User */ \"./src/User.ts\");\n/* harmony import */ var _workerManager__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../workerManager */ \"./src/workerManager.ts\");\nvar __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (undefined && undefined.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\n\n\n\n\n\nvar initSocketServer = function (httpsServer) {\n    var io = new socket_io__WEBPACK_IMPORTED_MODULE_0__.Server(httpsServer, {\n        allowEIO3: true,\n        cors: { origin: \"*\" },\n    });\n    io.on(\"connection\" /* SOCKET_CONNECTION */, function (socket) {\n        //room action event\n        socket.on(\"CHECK_ROOM_ALREADY\" /* CHECK_ROOM_ALREADY */, function (data, callback) {\n            return onCheckRoomAlready(data, callback);\n        });\n        socket.on(\"disconnect\" /* SOCKET_DISCONNECT */, function (data, callback) {\n            return onUserDisconnect(socket);\n        });\n        socket.on(\"SOCKET_CREATE_ROOM\" /* SOCKET_CREATE_ROOM */, function (data, callback) {\n            return onCreateRoom(io, data, callback);\n        });\n        socket.on(\"SOCKET_USER_JOIN_ROOM\" /* SOCKET_USER_JOIN_ROOM */, function (data, callback) { return onJoinRoom(io, socket, data, callback); });\n        socket.on(\"SOCKET_GET_ROOM_INFO\" /* SOCKET_GET_ROOM_INFO */, function (data, callback) {\n            return onGetRoomInfo(socket, data, callback);\n        });\n        socket.on(\"SOCKET_EXIT_ROOM\" /* SOCKET_EXIT_ROOM */, function (data, callback) {\n            return onExitRoom(socket, data, callback);\n        });\n        socket.on(\"SOCKET_SEND_MESSAGE\" /* SOCKET_SEND_MESSAGE */, function (data, callback) {\n            return onSendMessage(socket, data, callback);\n        });\n        socket.on(\"SOCKET_GET_MESSAGE_IN_ROOM\" /* SOCKET_GET_MESSAGE_IN_ROOM */, function (data, callback) {\n            return onGetMessageInRoom(socket, data, callback);\n        });\n        socket.on(\"SOCKET_CHANGE_ROOM_PASSWORD\" /* SOCKET_CHANGE_ROOM_PASSWORD */, function (data, callback) {\n            return onChangeRoomPassword(socket, data, callback);\n        });\n        // rtc action event\n        socket.on(\"GET_ROUTER_CAPABILITIES\" /* GET_ROUTER_CAPABILITIES */, function (data, callback) {\n            return onGetRouterRtpCapabilities(socket, data, callback);\n        });\n        socket.on(\"CLOSE_PRODUCER\" /* CLOSE_PRODUCER */, function (data, callback) {\n            return onCloseProducer(socket, data, callback);\n        });\n        socket.on(\"GET_PRODUCER\" /* GET_PRODUCER */, function (data, callback) {\n            return onGetProduce(socket, data, callback);\n        });\n        socket.on(\"CREATE_RTC_TRANSPORT\" /* CREATE_TRANSPORT */, function (data, callback) {\n            return onCreateTransport(socket, data, callback);\n        });\n        socket.on(\"CONNECT_RTC_TRANSPORT\" /* CONNECT_TRANSPORT */, function (data, callback) {\n            return onConnectTransport(socket, data, callback);\n        });\n        socket.on(\"CREATE_PRODUCE\" /* CREATE_PRODUCE */, function (data, callback) {\n            return onCreateProduce(socket, data, callback);\n        });\n        socket.on(\"CREATE_CONSUME\" /* CREATE_CONSUME */, function (data, callback) {\n            return onCreateConsume(socket, data, callback);\n        });\n        socket.on(\"GET_PRODUCER_OF_USER_KEY\" /* GET_PRODUCER_OF_USER_KEY */, function (data, callback) {\n            return onGetProducerOfuserKey(socket, data, callback);\n        });\n    });\n};\nvar onGetProducerOfuserKey = function (socket, data, callback) {\n    var roomname = socket.roomname, id = socket.id;\n    var room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n    var user = Array.from(room.listUser.values()).filter(function (user) {\n        if (user.isKey) {\n            return user;\n        }\n    })[0];\n    console.log(user);\n    if (!_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(roomname)) {\n        var message = \"Room not found!\";\n        var reponse = {\n            status: 0,\n            message: message,\n            data: null,\n        };\n        console.log(message);\n        return callback(reponse);\n    }\n    else {\n        var producerList_1 = [];\n        user.producers.forEach(function (producer) {\n            producerList_1.push({\n                producer_id: producer.id,\n                peerName: user.username,\n                peerId: user.socketId,\n            });\n        });\n        var message = \"User key producer get success!\";\n        var reponse = {\n            status: 1,\n            message: message,\n            data: producerList_1,\n        };\n        console.log(message);\n        return callback(reponse);\n    }\n};\nvar onCreateRoom = function (io, data, callback) {\n    var roomname = data.roomname, password = data.password;\n    if (_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(roomname)) {\n        var message = \"Room already exist!\";\n        var reponse = {\n            status: 0,\n            message: message,\n            data: { roomname: roomname, password: password },\n        };\n        console.log(message);\n        return callback(reponse);\n    }\n    else {\n        var worker = (0,_workerManager__WEBPACK_IMPORTED_MODULE_4__.getMediasoupWorker)();\n        var room = new _Room__WEBPACK_IMPORTED_MODULE_1__.Room(roomname, password, worker, io);\n        _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.set(roomname, room);\n        var message = \"Room: \" + roomname + \" create success!\";\n        var reponse = {\n            status: 1,\n            message: message,\n            data: { roomname: roomname, password: password },\n        };\n        return callback(reponse);\n    }\n};\nvar onJoinRoom = function (io, socket, data, callback) {\n    var roomname = data.roomname, password = data.password, username = data.username;\n    if (!_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(roomname)) {\n        var message = \"Room does not exist!\";\n        var reponse = {\n            status: 0,\n            message: message,\n            data: { roomname: roomname, password: password },\n        };\n        console.log(message);\n        return callback(reponse);\n    }\n    else {\n        var room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n        if (room.password !== password) {\n            var message = \"Password fail!\";\n            var reponse = {\n                status: 0,\n                message: message,\n                data: { roomname: roomname, password: password },\n            };\n            console.log(message);\n            return callback(reponse);\n        }\n        else {\n            var message = \"user \" + username + \" join room \" + room.name + \" success!\";\n            var user = new _User__WEBPACK_IMPORTED_MODULE_3__.User(io, socket.id, username, false);\n            if (room.listUser.size === 0) {\n                user.isKey = true;\n            }\n            room.addUser(user);\n            socket.roomname = roomname;\n            var reponse = {\n                status: 1,\n                message: message,\n                data: room.getListUser(),\n            };\n            console.log(message);\n            room.broadCast(socket.id, \"SOCKET_USER_JOIN_ROOM\" /* SOCKET_USER_JOIN_ROOM */, {\n                name: username,\n                id: user.socketId,\n            });\n            return callback(reponse);\n        }\n    }\n};\nvar onGetRoomInfo = function (socket, data, callback) {\n    var roomname = socket.roomname, id = socket.id;\n    var room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n    var message = \"get roominfo: \" + roomname + \" success!\";\n    var reponse = {\n        status: 1,\n        message: message,\n        data: { name: room.name, password: room.password },\n    };\n    console.log(message);\n    return callback(reponse);\n};\nvar onChangeRoomPassword = function (socket, password, callback) {\n    var roomname = socket.roomname, id = socket.id;\n    var room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n    room.password = password;\n    var message = \"Password change success!\";\n    var reponse = {\n        status: 1,\n        message: message,\n        data: message,\n    };\n    console.log(message);\n    return callback(reponse);\n};\nvar onUserDisconnect = function (socket) { return __awaiter(void 0, void 0, void 0, function () {\n    var roomname, id, room, user;\n    return __generator(this, function (_a) {\n        switch (_a.label) {\n            case 0:\n                roomname = socket.roomname, id = socket.id;\n                if (!roomname)\n                    return [2 /*return*/];\n                room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n                user = room.listUser.get(id);\n                return [4 /*yield*/, room.removeUser(user.socketId)];\n            case 1:\n                _a.sent();\n                room.broadCast(id, \"SOCKET_USER_LEFT_ROOM\" /* SOCKET_USER_LEFT_ROOM */, {\n                    name: user.username,\n                    id: user.socketId,\n                    isKey: user.isKey\n                });\n                if (room.listUser.size === 0) {\n                    _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.delete(roomname);\n                }\n                console.log(\"---disconnect--- name: \" + user.username);\n                return [2 /*return*/];\n        }\n    });\n}); };\nvar onExitRoom = function (socket, data, callback) { return __awaiter(void 0, void 0, void 0, function () {\n    var roomname, id, message_1, reponse_1, room, user, message, reponse;\n    return __generator(this, function (_a) {\n        switch (_a.label) {\n            case 0:\n                roomname = socket.roomname, id = socket.id;\n                if (!_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(socket.roomname)) {\n                    message_1 = \"not currently in a room\";\n                    reponse_1 = {\n                        status: 1,\n                        message: message_1,\n                        data: null,\n                    };\n                    console.log(message_1);\n                    return [2 /*return*/, callback(reponse_1)];\n                }\n                room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n                user = room.listUser.get(id);\n                return [4 /*yield*/, room.removeUser(user.socketId)];\n            case 1:\n                _a.sent();\n                if (user.isKey) {\n                    _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.delete(roomname);\n                }\n                if (room.listUser.size === 0) {\n                    _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.delete(roomname);\n                }\n                socket.roomname = null;\n                message = \"---exit room--- name: \" + user.username;\n                reponse = {\n                    status: 1,\n                    message: message,\n                    data: null,\n                };\n                console.log(message);\n                return [2 /*return*/, callback(reponse)];\n        }\n    });\n}); };\nvar onCreateTransport = function (socket, data, callback) { return __awaiter(void 0, void 0, void 0, function () {\n    var roomname, id, room, user, router, params, message, reponse, err_1, message, reponse;\n    return __generator(this, function (_a) {\n        switch (_a.label) {\n            case 0:\n                _a.trys.push([0, 2, , 3]);\n                if (!_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(socket.roomname))\n                    return [2 /*return*/];\n                roomname = socket.roomname, id = socket.id;\n                room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n                user = room.listUser.get(id);\n                router = room.router;\n                return [4 /*yield*/, user.createTransport(router)];\n            case 1:\n                params = (_a.sent()).params;\n                message = \"create transport success!\";\n                reponse = {\n                    status: 1,\n                    message: message,\n                    data: params,\n                };\n                console.log(message);\n                return [2 /*return*/, callback(reponse)];\n            case 2:\n                err_1 = _a.sent();\n                message = \"create transport fail!\";\n                reponse = {\n                    status: 0,\n                    message: message,\n                    data: err_1.message,\n                };\n                console.log(message);\n                return [2 /*return*/, callback(reponse)];\n            case 3: return [2 /*return*/];\n        }\n    });\n}); };\nvar onConnectTransport = function (socket, data, callback) { return __awaiter(void 0, void 0, void 0, function () {\n    var roomname, id, room, user, transport_id, dtlsParameters;\n    return __generator(this, function (_a) {\n        switch (_a.label) {\n            case 0:\n                if (!_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(socket.roomname))\n                    return [2 /*return*/];\n                roomname = socket.roomname, id = socket.id;\n                room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n                user = room.listUser.get(id);\n                transport_id = data.transport_id, dtlsParameters = data.dtlsParameters;\n                return [4 /*yield*/, user.connectTransport(transport_id, dtlsParameters)];\n            case 1:\n                _a.sent();\n                callback(\"success\");\n                return [2 /*return*/];\n        }\n    });\n}); };\nvar onCreateConsume = function (socket, data, callback) { return __awaiter(void 0, void 0, void 0, function () {\n    var roomname, id, message_2, reponse_2, consumerTransportId, producerId, rtpCapabilities, room, user, params, message, reponse;\n    return __generator(this, function (_a) {\n        switch (_a.label) {\n            case 0:\n                roomname = socket.roomname, id = socket.id;\n                if (!_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(roomname)) {\n                    message_2 = \"Room not found!\";\n                    reponse_2 = {\n                        status: 0,\n                        message: message_2,\n                        data: null,\n                    };\n                    console.log(message_2);\n                    return [2 /*return*/, callback(reponse_2)];\n                }\n                consumerTransportId = data.consumerTransportId, producerId = data.producerId, rtpCapabilities = data.rtpCapabilities;\n                room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(socket.roomname);\n                user = room.listUser.get(id);\n                return [4 /*yield*/, user.createConsumer(consumerTransportId, producerId, rtpCapabilities)];\n            case 1:\n                params = _a.sent();\n                message = \"Consume create success!\";\n                reponse = {\n                    status: 1,\n                    message: message,\n                    data: params,\n                };\n                console.log(message);\n                return [2 /*return*/, callback(reponse)];\n        }\n    });\n}); };\nvar onCreateProduce = function (socket, data, callback) { return __awaiter(void 0, void 0, void 0, function () {\n    var roomname, id, message_3, reponse_3, producerTransportId, rtpParameters, kind, room, user, producer, message, reponse;\n    return __generator(this, function (_a) {\n        switch (_a.label) {\n            case 0:\n                roomname = socket.roomname, id = socket.id;\n                if (!_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(roomname)) {\n                    message_3 = \"Room not found!\";\n                    reponse_3 = {\n                        status: 0,\n                        message: message_3,\n                        data: null,\n                    };\n                    console.log(message_3);\n                    return [2 /*return*/, callback(reponse_3)];\n                }\n                producerTransportId = data.producerTransportId, rtpParameters = data.rtpParameters, kind = data.kind;\n                room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(socket.roomname);\n                user = room.listUser.get(id);\n                return [4 /*yield*/, user.createProducer(producerTransportId, rtpParameters, kind)];\n            case 1:\n                producer = _a.sent();\n                console.log(\"producer\", producer.id);\n                room.broadCast(id, \"NEW_PRODUCER\" /* NEW_PRODUCER */, [\n                    {\n                        producer_id: producer.id,\n                        producer_socket_id: id,\n                        peerName: user.username,\n                        peerId: user.socketId,\n                        isKey: user.isKey\n                    },\n                ]);\n                message = \"Producer create success!\";\n                reponse = {\n                    status: 1,\n                    message: message,\n                    data: {\n                        producerId: producer.id,\n                        producer: producer,\n                        username: user.username,\n                        socketId: user.socketId,\n                    },\n                };\n                return [2 /*return*/, callback(reponse)];\n        }\n    });\n}); };\nvar onGetProduce = function (socket, data, callback) {\n    var roomname = socket.roomname, id = socket.id;\n    if (!_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(roomname)) {\n        var message_4 = \"Room not found!\";\n        var reponse_4 = {\n            status: 0,\n            message: message_4,\n            data: null,\n        };\n        console.log(message_4);\n        return callback(reponse_4);\n    }\n    var room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(socket.roomname);\n    var producerList = room.getProducerListForPeer(id);\n    // room.send(id,RTC_EVENTS.NEW_PRODUCER,producerList)\n    console.log(producerList);\n    var message = \"get GetProduce success!\";\n    var reponse = {\n        status: 1,\n        message: message,\n        data: producerList,\n    };\n    console.log(message);\n    return callback(reponse);\n};\nvar onGetRouterRtpCapabilities = function (socket, data, callback) {\n    var room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(socket.roomname);\n    var routerCapabilities = room.router.rtpCapabilities;\n    try {\n        var message = \"get RouterRtpCapabilities success!\";\n        var reponse = {\n            status: 1,\n            message: message,\n            data: routerCapabilities,\n        };\n        console.log(message);\n        return callback(reponse);\n    }\n    catch (e) {\n        var message = \"get RouterRtpCapabilities fail!\";\n        var reponse = {\n            status: 0,\n            message: message,\n            data: e.message,\n        };\n        console.log(message);\n        return callback(reponse);\n    }\n};\nvar onCloseProducer = function (socket, data, callback) {\n    var roomname = socket.roomname, id = socket.id;\n    if (!_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(roomname)) {\n        var message_5 = \"Room not found!\";\n        var reponse_5 = {\n            status: 0,\n            message: message_5,\n            data: null,\n        };\n        console.log(message_5);\n        return callback(reponse_5);\n    }\n    var producer_id = data.producer_id;\n    var room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n    var user = room.listUser.get(id);\n    user.closeProducer(producer_id);\n    // room.broadCast(id, RTC_EVENTS.UPDATE_CONSUME, null);\n    var message = \"---producer close--- name: \" + user.username;\n    var reponse = {\n        status: 1,\n        message: message,\n        data: null,\n    };\n    console.log(message);\n    return callback(reponse);\n};\nvar onGetMessageInRoom = function (socket, data, callback) {\n    var roomname = socket.roomname, id = socket.id;\n    if (!_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(roomname)) {\n        var message_6 = \"Room not found!\";\n        var reponse_6 = {\n            status: 0,\n            message: message_6,\n            data: null,\n        };\n        console.log(message_6);\n        return callback(reponse_6);\n    }\n    var room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n    var message = \"---get message success--- \";\n    var reponse = {\n        status: 1,\n        message: message,\n        data: room.listMessage,\n    };\n    console.log(message);\n    return callback(reponse);\n};\nvar onSendMessage = function (socket, message, callback) {\n    var roomname = socket.roomname, id = socket.id;\n    var room = _roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.get(roomname);\n    room.addMessage(socket.id, message);\n};\nvar onCheckRoomAlready = function (data, callback) {\n    console.log(data);\n    if (_roomManager__WEBPACK_IMPORTED_MODULE_2__.roomList.has(data.roomname)) {\n        var message = \"Room already exist!\";\n        var reponse = {\n            status: 1,\n            message: message,\n            data: true,\n        };\n        callback(reponse);\n    }\n    else {\n        var message = \"Room is null!\";\n        var reponse = {\n            status: 1,\n            message: message,\n            data: false,\n        };\n        callback(reponse);\n    }\n};\n\n\n\n//# sourceURL=webpack://call_server_es6/./src/servers/socket.ts?");

/***/ }),

/***/ "./src/workerManager.ts":
/*!******************************!*\
  !*** ./src/workerManager.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"getMediasoupWorker\": () => (/* binding */ getMediasoupWorker),\n/* harmony export */   \"initWorker\": () => (/* binding */ initWorker)\n/* harmony export */ });\n/* harmony import */ var _config__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./config */ \"./src/config.ts\");\n/* harmony import */ var mediasoup__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! mediasoup */ \"mediasoup\");\n/* harmony import */ var mediasoup__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(mediasoup__WEBPACK_IMPORTED_MODULE_1__);\nvar __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (undefined && undefined.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\n\n\nvar workers = [];\nvar nextMediasoupWorkerIdx = 0;\nvar initWorker = function () { return __awaiter(void 0, void 0, void 0, function () {\n    var numWorkers, _loop_1, i, error_1;\n    return __generator(this, function (_a) {\n        switch (_a.label) {\n            case 0:\n                _a.trys.push([0, 5, , 6]);\n                numWorkers = _config__WEBPACK_IMPORTED_MODULE_0__.config.mediasoup.numWorkers;\n                _loop_1 = function (i) {\n                    var workerconfig, worker;\n                    return __generator(this, function (_b) {\n                        switch (_b.label) {\n                            case 0:\n                                workerconfig = {\n                                    logLevel: _config__WEBPACK_IMPORTED_MODULE_0__.config.mediasoup.worker.logLevel,\n                                    logTags: _config__WEBPACK_IMPORTED_MODULE_0__.config.mediasoup.worker.logTags,\n                                    rtcMinPort: _config__WEBPACK_IMPORTED_MODULE_0__.config.mediasoup.worker.rtcMinPort,\n                                    rtcMaxPort: _config__WEBPACK_IMPORTED_MODULE_0__.config.mediasoup.worker.rtcMaxPort,\n                                };\n                                return [4 /*yield*/, mediasoup__WEBPACK_IMPORTED_MODULE_1__.createWorker(workerconfig)];\n                            case 1:\n                                worker = _b.sent();\n                                worker.on(\"died\", function () {\n                                    console.error(\"mediasoup worker died, exiting in 2 seconds... [pid:%d]\", worker.pid);\n                                    setTimeout(function () { return process.exit(1); }, 2000);\n                                });\n                                // setInterval(async () => {\n                                //   const usage = await worker.getResourceUsage();\n                                //   console.log(\n                                //     \"mediasoup Worker resource usage [pid:%d]: %o\",\n                                //     worker.pid,\n                                //     usage\n                                //   );\n                                // }, 12000);\n                                workers.push(worker);\n                                return [2 /*return*/];\n                        }\n                    });\n                };\n                i = 0;\n                _a.label = 1;\n            case 1:\n                if (!(i < numWorkers)) return [3 /*break*/, 4];\n                return [5 /*yield**/, _loop_1(i)];\n            case 2:\n                _a.sent();\n                _a.label = 3;\n            case 3:\n                i++;\n                return [3 /*break*/, 1];\n            case 4: return [3 /*break*/, 6];\n            case 5:\n                error_1 = _a.sent();\n                console.error(error_1);\n                return [3 /*break*/, 6];\n            case 6: return [2 /*return*/];\n        }\n    });\n}); };\nvar getMediasoupWorker = function () {\n    var worker = workers[nextMediasoupWorkerIdx];\n    if (++nextMediasoupWorkerIdx === workers.length)\n        nextMediasoupWorkerIdx = 0;\n    return worker;\n};\n\n\n\n//# sourceURL=webpack://call_server_es6/./src/workerManager.ts?");

/***/ }),

/***/ "express":
/*!**************************!*\
  !*** external "express" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("express");;

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");;

/***/ }),

/***/ "httpolyglot":
/*!******************************!*\
  !*** external "httpolyglot" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("httpolyglot");;

/***/ }),

/***/ "mediasoup":
/*!****************************!*\
  !*** external "mediasoup" ***!
  \****************************/
/***/ ((module) => {

module.exports = require("mediasoup");;

/***/ }),

/***/ "os":
/*!*********************!*\
  !*** external "os" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("os");;

/***/ }),

/***/ "socket.io":
/*!****************************!*\
  !*** external "socket.io" ***!
  \****************************/
/***/ ((module) => {

module.exports = require("socket.io");;

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/compat get default export */
/******/ 	(() => {
/******/ 		// getDefaultExport function for compatibility with non-harmony modules
/******/ 		__webpack_require__.n = (module) => {
/******/ 			var getter = module && module.__esModule ?
/******/ 				() => (module['default']) :
/******/ 				() => (module);
/******/ 			__webpack_require__.d(getter, { a: getter });
/******/ 			return getter;
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = __webpack_require__("./src/index.ts");
/******/ 	
/******/ })()
;